!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).aimapi={})}(this,(function(e){"use strict";function t(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var n="AIMv4_2",i="http://www.w3.org/2001/XMLSchema-instance",a="http://www.w3.org/1999/02/22-rdf-syntax-ns#",o="gme://caCORE.caCORE/4.4/edu.northwestern.radiology.AIM",s="gme://caCORE.caCORE/4.4/edu.northwestern.radiology.AIM AIM_v4.2_rv2_XML.xsd",c={"1.2.840.10008.5.1.4.1.1.2":{codeValue:"CT",codeMeaning:"Computed Tomography",codingSchemeDesignator:"DCM",codingSchemeVersion:"20121129"},"1.2.840.10008.5.1.4.1.1.1":{codeValue:"CR",codeMeaning:"Computed Radiography",codingSchemeDesignator:"DCM",codingSchemeVersion:"20121129"},"1.2.840.10008.5.1.4.1.1.128":{codeValue:"PT",codeMeaning:"Positron emission tomography",codingSchemeDesignator:"DCM",codingSchemeVersion:"20121129"},"1.2.840.10008.5.1.4.1.1.4":{codeValue:"MR",codeMeaning:"Magnetic Resonance",codingSchemeDesignator:"DCM",codingSchemeVersion:"20121129"},"1.2.840.10008.5.1.4.1.1.6.1":{codeValue:"US",codeMeaning:"Ultrasound",codingSchemeDesignator:"DCM",codingSchemeVersion:"20121129"},"1.2.840.10008.5.1.4.1.1.1.2":{codeValue:"MG",codeMeaning:"Mammography",codingSchemeDesignator:"DCM",codingSchemeVersion:"20121129"},"1.2.840.10008.5.1.4.1.1.1.2.1":{codeValue:"MG",codeMeaning:"Mammography",codingSchemeDesignator:"DCM",codingSchemeVersion:"20121129"},CT:{codeValue:"CT",codeMeaning:"Computed Tomography",codingSchemeDesignator:"DCM",codingSchemeVersion:"20121129"},CR:{codeValue:"CR",codeMeaning:"Computed Radiography",codingSchemeDesignator:"DCM",codingSchemeVersion:"20121129"},PT:{codeValue:"PT",codeMeaning:"Positron emission tomography",codingSchemeDesignator:"DCM",codingSchemeVersion:"20121129"},MR:{codeValue:"MR",codeMeaning:"Magnetic Resonance",codingSchemeDesignator:"DCM",codingSchemeVersion:"20121129"},US:{codeValue:"US",codeMeaning:"Ultrasound",codingSchemeDesignator:"DCM",codingSchemeVersion:"20121129"},MG:{codeValue:"MG",codeMeaning:"Mammography",codingSchemeDesignator:"DCM",codingSchemeVersion:"20121129"}};function r(){let e="2.25."+Math.floor(1+9*Math.random());for(let t=0;t<38;t++)e+=Math.floor(10*Math.random());return e}class l{constructor(e,l,u){t(this,"getDate",()=>{const e=new Date;return e.getFullYear()+("0"+(e.getMonth()+1)).slice(-2)+("0"+e.getDate()).slice(-2)+("0"+e.getHours()).slice(-2)+("0"+e.getMinutes()).slice(-2)+("0"+e.getSeconds()).slice(-2)}),t(this,"_createObject",(e,t)=>{var n={};return n[e]={value:t},n}),t(this,"_createDimension",(e,t=0,n=1)=>({Dimension:[Object.assign({},this._createObject("size",n),this._createObject("index",t),this._createObject("label",e))]})),t(this,"_createDoubleDataType",()=>({dataType:{code:"C48870",codeSystem:"NCI","iso:displayName":{"xmlns:iso":"uri:iso.org:21090",value:"Double"}}})),t(this,"_createCalcResult",(e,t,n,i="")=>{var a=this._createObject("unitOfMeasure",e);return Object.assign(a,this._createDoubleDataType()),a["xsi:type"]="CompactCalculationResult",a.dimensionCollection=this._createDimension(i+t),a.type="Scalar",Object.assign(a,this._createObject("value",`${n}`)),a}),t(this,"_createTypeCode",(e="11203",t="DCM",n="Attenuation Coefficient")=>{var i={};return i.code=e,i.codeSystemName=t,i["iso:displayName"]={"xmlns:iso":"uri:iso.org:21090",value:n},i}),t(this,"createLengthCalcEntity",e=>{let{unit:t,value:n}=e;var i={};i.calculationResultCollection={CalculationResult:[this._createCalcResult(t,"LineLength",n)]},i.description={value:"Length"};const a=r();return i.uniqueIdentifier={root:a},i.typeCode=[this._createTypeCode("G-D7FE","SRT","Length")],this.imageAnnotations.ImageAnnotation[0].calculationEntityCollection.CalculationEntity.push(i),a}),t(this,"createLongAxisCalcEntity",e=>{let{unit:t,value:n}=e;var i={};i.calculationResultCollection={CalculationResult:[this._createCalcResult(t,"LongAxis",n)]},i.description={value:"LongAxis"};const a=r();return i.uniqueIdentifier={root:a},i.typeCode=[this._createTypeCode("G-A185","SRT","LongAxis")],this.imageAnnotations.ImageAnnotation[0].calculationEntityCollection.CalculationEntity.push(i),a}),t(this,"createShortAxisCalcEntity",e=>{let{unit:t,value:n}=e;var i={};i.calculationResultCollection={CalculationResult:[this._createCalcResult(t,"ShortAxis",n)]},i.description={value:"ShortAxis"};const a=r();return i.uniqueIdentifier={root:a},i.typeCode=[this._createTypeCode("G-A186","SRT","ShortAxis")],this.imageAnnotations.ImageAnnotation[0].calculationEntityCollection.CalculationEntity.push(i),a}),t(this,"createMeanCalcEntity",(e,t)=>{var{unit:n,mean:i}=e;console.log("Unit",n);const{unitObj:a,typeCodeDcm:o}=this._getAimUnitAndDcmTypeCode(n);var s={};s.calculationResultCollection={CalculationResult:[this._createCalcResult(a,"Mean",i,t)]},s.description={value:"Mean"};const c=r();return s.uniqueIdentifier={root:c},s.typeCode=[o,this._createTypeCode("R-00317","SRT","Mean")],this.imageAnnotations.ImageAnnotation[0].calculationEntityCollection.CalculationEntity.push(s),c}),t(this,"createStdDevCalcEntity",(e,t)=>{var{unit:n,stdDev:i}=e;const{unitObj:a,typeCodeDcm:o}=this._getAimUnitAndDcmTypeCode(n);var s={};s.calculationResultCollection={CalculationResult:[this._createCalcResult(a,"Standard Deviation",i,t)]},s.description={value:"Standard Deviation"};const c=r();return s.uniqueIdentifier={root:c},s.typeCode=[o,this._createTypeCode("R-10047","SRT","Standard Deviation")],this.imageAnnotations.ImageAnnotation[0].calculationEntityCollection.CalculationEntity.push(s),c}),t(this,"createMinCalcEntity",(e,t)=>{var{unit:n,min:i}=e;const{unitObj:a,typeCodeDcm:o}=this._getAimUnitAndDcmTypeCode(n);var s={};s.calculationResultCollection={CalculationResult:[this._createCalcResult(a,"Minimum",i,t)]},s.description={value:"Minimum"};const c=r();return s.uniqueIdentifier={root:c},s.typeCode=[o,this._createTypeCode("R-404FB","SRT","Minimum")],this.imageAnnotations.ImageAnnotation[0].calculationEntityCollection.CalculationEntity.push(s),c}),t(this,"createMaxCalcEntity",(e,t)=>{var{unit:n,max:i}=e;const{unitObj:a,typeCodeDcm:o}=this._getAimUnitAndDcmTypeCode(n);var s={};s.calculationResultCollection={CalculationResult:[this._createCalcResult(a,"Maximum",i,t)]},s.description={value:"Maximum"};const c=r();return s.uniqueIdentifier={root:c},s.typeCode=[o,this._createTypeCode("G-A437","SRT","Maximum")],this.imageAnnotations.ImageAnnotation[0].calculationEntityCollection.CalculationEntity.push(s),c}),t(this,"_getAimUnitAndDcmTypeCode",e=>"hu"===e?{unit:"[hnsf'U]",typeCodeDcm:this._createTypeCode()}:"suv"===e?{unit:"{SUVbw}g/ml",typeCodeDcm:this._createTypeCode(126401,"DCM","SUVbw")}:void 0),t(this,"createVolumeCalcEntity",(e,t)=>{var{unit:n,volume:i}=e,a={};a.calculationResultCollection={CalculationResult:[this._createCalcResult(n,"Volume",i,t)]},a.description={value:"Volume"};const o=r();return a.uniqueIdentifier={root:o},a.typeCode=[this._createTypeCode("RID28668","Radlex","Volume")],this.imageAnnotations.ImageAnnotation[0].calculationEntityCollection.CalculationEntity.push(a),o}),t(this,"createCommonCalcEntites",(e,t,n,i,a)=>{var o=[];return o.push(this.createMeanCalcEntity(e,a)),o.push(this.createStdDevCalcEntity(t,a)),o.push(this.createMinCalcEntity(n,a)),o.push(this.createMaxCalcEntity(i,a)),o}),t(this,"createLongAxisCalcEntities",(e,t,n,i,a)=>{var o=[];return o.push(this.createLongAxisCalcEntity(e)),o.concat(this.createCommonCalcEntites(t,n,i,a,"LongAxis_"))}),t(this,"createShortAxisCalcEntities",(e,t,n,i,a)=>{var o=[];return o.push(this.createShortAxisCalcEntity(e)),o.concat(this.createCommonCalcEntites(t,n,i,a,"ShortAxis_"))}),t(this,"createCalculationEntityCollection",e=>{var t={};return t.calculationEntityCollection={CalculationEntity:e},t}),t(this,"_createCoordinate",(e,t)=>{var n={};return n.x={value:e.x},n.coordinateIndex={value:t},n.y={value:e.y},n}),t(this,"_createCoordinateArray",e=>{var t=[];return e.forEach((e,n)=>{t.push(this._createCoordinate(e,n))}),t}),t(this,"addMarkupEntity",(e,t,n,i)=>{const a=this._getFrameNumber(i);a>-1&&(i=i.split("&frame=")[0]);var o={includeFlag:{value:!0}};o.twoDimensionSpatialCoordinateCollection={TwoDimensionSpatialCoordinate:this._createCoordinateArray(n)};const s=r();return o.shapeIdentifier={value:t},o.uniqueIdentifier={root:s},o["xsi:type"]=e,o.imageReferenceUid={root:i},o.referencedFrameNumber={value:a},this.imageAnnotations.ImageAnnotation[0].markupEntityCollection.MarkupEntity.push(o),s}),t(this,"_getFrameNumber",e=>{const t=e.split("frame=");return t.length>1?t[1]:1}),t(this,"_createModality",()=>{const e=this.temp.image[0].sopClassUid;if(e&&c[e])var{codeValue:t,codingSchemeDesignator:n,codeMeaning:i,codingSchemeVersion:a}=c[e];else{const e=this.temp.series.modality;if(e&&c[e])var{codeValue:t,codingSchemeDesignator:n,codeMeaning:i,codingSchemeVersion:a}=c[e]}var o={};return o.code=t||"",o.codeSystemName=n||"",o["iso:displayName"]={"xmlns:iso":"uri:iso.org:21090",value:i||""},o.codeSystemVersion=a||"",o}),t(this,"_createImageCollection",()=>{let e={Image:[]};return this.temp.image.forEach(t=>{let{sopClassUid:n,sopInstanceUid:i}=t;n={root:n},i={root:i},e.Image.push({sopClassUid:n,sopInstanceUid:i})}),e}),t(this,"_createImageSeries",()=>{var e={};return e.modality=this._createModality(),e.imageCollection=this._createImageCollection(),e.instanceUid={root:this.temp.series.instanceUid},e}),t(this,"_createImageStudy",()=>{const{accessionNumber:e,startTime:t,instanceUid:n,startDate:i}=this.temp.study;var a={};return a.imageSeries=this._createImageSeries(),a.startTime={value:t},a.instanceUid={root:n},a.startDate={value:i},a.accessionNumber={value:e},a}),t(this,"_createImageReferenceEntity",()=>{var e={};return e.imageStudy=this._createImageStudy(),e["xsi:type"]="DicomImageReferenceEntity",e.uniqueIdentifier={root:r()},e}),t(this,"_createImageReferanceEntityCollection",()=>{var e={};return e.ImageReferenceEntity=[this._createImageReferenceEntity()],e}),t(this,"_createImageAnnotations",e=>{const{name:t,comment:n,typeCode:i,imagingPhysicalEntityCollection:a,imagingObservationEntityCollection:o,inferenceEntityCollection:s}=this.temp.aim;var c={};return c.uniqueIdentifier={root:r()},c.typeCode=i,c.dateTime={value:this.getDate()},c.name=t,c.comment=n,c.precedentReferencedAnnotationUid={root:""},a&&(c.imagingPhysicalEntityCollection=a),1===e&&(c.calculationEntityCollection={CalculationEntity:[]},c.markupEntityCollection={MarkupEntity:[]},c.imageAnnotationStatementCollection={ImageAnnotationStatement:[]}),o&&(c.imagingObservationEntityCollection=o),s&&(c.inferenceEntityCollection=s),c.imageReferenceEntityCollection=this._createImageReferanceEntityCollection(),c}),t(this,"createImageAnnotationStatement",(e,t,n)=>{var i,a={};i=1===e?"CalculationEntityReferencesMarkupEntityStatement":"CalculationEntityReferencesSegmentationEntityStatement",a["xsi:type"]=i,a.objectUniqueIdentifier={root:t},a.subjectUniqueIdentifier={root:n},this.imageAnnotations.ImageAnnotation[0].imageAnnotationStatementCollection.ImageAnnotationStatement.push(a)}),t(this,"createSegmentationEntity",e=>{var t={};t.referencedSopInstanceUid={root:e.referencedSopInstanceUid},t.segmentNumber={value:1},t.seriesInstanceUid={root:e.seriesInstanceUid},t.studyInstanceUid={root:e.studyInstanceUid},t["xsi:type"]="DicomSegmentationEntity",t.sopClassUid={root:"1.2.840.10008.5.1.4.1.1.66.4"},t.sopInstanceUid={root:e.sopInstanceUid},t.uniqueIdentifier={root:r()};const n=this.imageAnnotations.ImageAnnotation[0];return n.segmentationEntityCollection||(n.segmentationEntityCollection={},n.segmentationEntityCollection.SegmentationEntity=[]),n.segmentationEntityCollection.SegmentationEntity.push(t),t.uniqueIdentifier}),t(this,"_createPerson",e=>{const{sex:t,name:n,patientId:i,birthDate:a}=e;return{sex:{value:t},name:{value:n},id:{value:i},birthDate:{value:a}}}),t(this,"_createEquipment",e=>{const{manufacturerName:t,manufacturerModelName:n,softwareVersion:i}=e;return{manufacturerName:{value:t},manufacturerModelName:{value:n},softwareVersion:{value:i}}}),t(this,"_createUser",e=>{const{loginName:t,name:n}=e;return{loginName:{value:t},name:{value:n}}}),t(this,"getAim",()=>(delete this.temp,`{"ImageAnnotationCollection": ${JSON.stringify(this)} } `)),this.temp={},({aim:this.temp.aim,study:this.temp.study,series:this.temp.series,image:this.temp.image,segmentation:this.temp.segmentation,equipment:this.temp.equipment,user:this.temp.user,person:this.temp.person}=e),this.xmlns=o,this["xmlns:rdf"]=a,this["xmlns:xsi"]=i,this.aimVersion=n,this["xsi:schemaLocation"]=s,this.uniqueIdentifier="",this.studyInstanceUid={root:this.temp.aim.studyInstanceUid},this.seriesInstanceUid={root:r()},this.accessionNumber={value:this.temp.study.accessionNumber},this.dateTime={value:this.getDate()},this.user=this._createUser(this.temp.user),this.equipment=this._createEquipment(this.temp.equipment),this.person=this._createPerson(this.temp.person),this.imageAnnotations={ImageAnnotation:[this._createImageAnnotations(l)]},this.uniqueIdentifier=void 0===u?{root:r()}:{root:u}}static parse(e){return new l(e)}}const u=1;function m(e,t){const n=function(e){return e.ImageAnnotationCollection.imageAnnotations.ImageAnnotation[0].imageAnnotationStatementCollection.ImageAnnotationStatement}(e);let i=[];return n.forEach(n=>{if(n.objectUniqueIdentifier.root===t){const t=n.subjectUniqueIdentifier.root;(function(e){return e.ImageAnnotationCollection.imageAnnotations.ImageAnnotation[0].calculationEntityCollection.CalculationEntity})(e).forEach(e=>{e.uniqueIdentifier.root===t&&i.push(function(e){var t={};const n=e.calculationResultCollection.CalculationResult[0];if(e.calculationResultCollection.CalculationResult[0].calculationDataCollection){const n=e.calculationResultCollection.CalculationResult[0].calculationDataCollection.CalculationData[0];t.value=n.value.value}else t.value=n.value.value;return t.type=e.description.value,t.unit=n.unitOfMeasure.value,t}(e))})}}),i}function d(e){const t=Array.isArray(e.PerFrameFunctionalGroupsSequence)?e.PerFrameFunctionalGroupsSequence[0]:e.PerFrameFunctionalGroupsSequence,n=Array.isArray(t.DerivationImageSequence)?t.DerivationImageSequence[0]:t.DerivationImageSequence;return Array.isArray(n.SourceImageSequence)?n.SourceImageSequence[0]:n.SourceImageSequence}e.createOfflineAimSegmentation=function(e,t){const n=function(e){var t={aim:{},study:{},series:{},equipment:{},person:{},image:[]};const{aim:n,study:i,series:a,equipment:o,person:s}=t;return n.studyInstanceUid=e.StudyInstanceUID||"",i.startTime=e.StudyTime||"",i.instanceUid=e.StudyInstanceUID||"",i.startDate=e.StudyDate||"",i.accessionNumber=e.AccessionNumber||"",a.instanceUid=e.ReferencedSeriesSequence.SeriesInstanceUID||"",t.image.push(function(e){const t=d(e);return{sopClassUid:t.ReferencedSOPClassUID||"",sopInstanceUid:t.ReferencedSOPInstanceUID||""}}(e)),o.manufacturerName=e.Manufacturer||"",o.manufacturerModelName=e.ManufacturerModelName||"",o.softwareVersion=e.SoftwareVersions||"",s.sex=e.PatientSex||"",s.name=e.PatientName||"",s.patientId=e.PatientID||"",s.birthDate=e.PatientBirthDate||"",t}(e);!function(e,t){if(t)e.user=t;else{let t={};t.loginName=sessionStorage.getItem("username"),t.name=sessionStorage.getItem("displayName"),e.user=t}}(n,t);const i=new l(n,u);return function(e,t,n){const i=e.createSegmentationEntity(t),{volume:a,min:o,max:s,mean:c,stdDev:r}=n;if(c){const t=e.createMeanCalcEntity({mean:c,unit:"[hnsf'U]"});e.createImageAnnotationStatement(2,i,t)}if(r){const t=e.createStdDevCalcEntity({stdDev:r,unit:"[hnsf'U]"});e.createImageAnnotationStatement(2,i,t)}if(o){const t=e.createMinCalcEntity({min:o,unit:"[hnsf'U]"});e.createImageAnnotationStatement(2,i,t)}if(s){const t=e.createMaxCalcEntity({max:s,unit:"[hnsf'U]"});e.createImageAnnotationStatement(2,i,t)}if(a){const t=e.createMaxCalcEntity({volume:a,unit:"mm3"});e.createImageAnnotationStatement(2,i,t)}}(i,function(e){const t=d(e);let n={};return n.referencedSopInstanceUid=t.ReferencedSOPInstanceUID,n.seriesInstanceUid=e.SeriesInstanceUID,n.studyInstanceUid=e.StudyInstanceUID,n.sopClassUid=e.SOPClassUID,n.sopInstanceUid=e.SOPInstanceUID,n}(e),{}),console.log("AIM in segmentation",i),{aim:i}},e.getAimImageData=function(e){var t={aim:{},study:{},series:{},equipment:{},person:{},image:[]};const{aim:n,study:i,series:a,equipment:o,person:s}=t;return n.studyInstanceUid=e.data.string("x0020000d")||"",i.startTime=e.data.string("x00080030")||"",i.instanceUid=e.data.string("x0020000d")||"",i.startDate=e.data.string("x00080020")||"",i.accessionNumber=e.data.string("x00080050")||"",a.instanceUid=e.data.string("x0020000e")||"",a.modality=e.data.string("x00080060")||"",t.image.push(function(e){return{sopClassUid:e.data.string("x00080016")||"",sopInstanceUid:e.data.string("x00080018")||""}}(e)),o.manufacturerName=e.data.string("x00080070")||"",o.manufacturerModelName=e.data.string("x00081090")||"",o.softwareVersion=e.data.string("x00181020")||"",s.sex=e.data.string("x00100040")||"",s.name=e.data.string("x00100010")||"",s.patientId=e.data.string("x00100020")||"",s.birthDate=e.data.string("x00100030")||"",t},e.getImageIdAnnotations=function(e){let t={};return e.forEach(e=>function(e,t){var n=e.ImageAnnotationCollection.imageAnnotations.ImageAnnotation[0];if(n.markupEntityCollection){n.markupEntityCollection.MarkupEntity.forEach(n=>{const{imageId:i,data:a}=function(e,t){let n=e.imageReferenceUid.root;const i=e.referencedFrameNumber.value;n=n+"&frame="+i;const a=e.uniqueIdentifier.root;let o=[];try{o=m(t,a)}catch(e){console.log("Can not get calculations",e)}const s=t.ImageAnnotationCollection.uniqueIdentifier.root;return{imageId:n,data:{markupType:e["xsi:type"],calculations:o,coordinates:e.twoDimensionSpatialCoordinateCollection.TwoDimensionSpatialCoordinate,markupUid:a,aimUid:s}}}(n,e);t[i]?t[i].push(a):t[i]=[a]})}if(n.segmentationEntityCollection){n.segmentationEntityCollection.SegmentationEntity.forEach(n=>{const{imageId:i,data:a}=function(e,t){const n=e.referencedSopInstanceUid.root,i=e.uniqueIdentifier.root,a=m(t,i),o=t.ImageAnnotationCollection.uniqueIdentifier.root;return{imageId:n,data:{markupType:e["xsi:type"],calculations:a,markupUid:i,aimUid:o}}}(n,e);t[i]?t[i].push(a):t[i]=[a]})}}(e,t)),t},Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=aimapi.min.js.map
